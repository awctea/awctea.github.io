<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Information Hierarchy Exercise</title>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-app.js";
  import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-firestore.js";

  // ðŸ”¹ Replace with your Firebase Web App config
const firebaseConfig = {
  apiKey: "AIzaSyAsGafeMKHVxAeUVAroHj-FqyPiRaDDyqE",
  authDomain: "test-769a6.firebaseapp.com",
  projectId: "test-769a6",
  storageBucket: "test-769a6.firebasestorage.app",
  messagingSenderId: "1073801314798",
  appId: "1:1073801314798:web:abd01ae67a5bc9c1eb0eff"
};
  
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  let tree = { id: Date.now() + Math.random(), nodes: [] };

  function createNode(title) {
    return { id: Date.now() + Math.random(), title: title || "New Item", children: [] };
  }

  function findNode(nodes, id) {
    for (const n of nodes) {
      if (n.id === id) return n;
      const child = findNode(n.children, id);
      if (child) return child;
    }
    return null;
  }

  function removeNode(nodes, id) {
    for (let i = 0; i < nodes.length; i++) {
      if (nodes[i].id === id) {
        nodes.splice(i, 1);
        return true;
      }
      if (nodes[i].children.length > 0) {
        const removed = removeNode(nodes[i].children, id);
        if (removed) return true;
      }
    }
    return false;
  }

  function renderTree(tree) {
    const container = document.getElementById("trees-container");
    container.innerHTML = "";

    const wrapper = document.createElement("div");
    wrapper.className = "tree-wrapper";
    wrapper.dataset.treeId = tree.id;

    const ul = document.createElement("ul");
    ul.className = "tree";
    wrapper.appendChild(ul);

    container.appendChild(wrapper);

    // Add two root nodes with placeholders if empty
    if (!tree.nodes.length) {
      const root1 = createNode("Root Node 1");
      root1.children.push(createNode("Placeholder 1"));
      root1.children.push(createNode("Placeholder 2"));

      const root2 = createNode("Root Node 2");
      root2.children.push(createNode("Placeholder 1"));
      root2.children.push(createNode("Placeholder 2"));

      tree.nodes.push(root1, root2);
    }

    renderNodes(ul, tree.nodes);
    initSortableForTree(ul);
  }

  function renderNodes(ul, nodes) {
    ul.innerHTML = "";
    nodes.forEach(node => {
      const li = document.createElement("li");
      li.dataset.nodeId = node.id;
      li.innerHTML = `
        <span class="title" contenteditable="true">${node.title}</span>
        <button class="add-btn">+Add</button>
        <button class="delete-btn">Delete</button>
      `;
      ul.appendChild(li);

      if (node.children.length) {
        const childUl = document.createElement("ul");
        li.appendChild(childUl);
        renderNodes(childUl, node.children);
        initSortableForTree(childUl);
      }

      li.querySelector(".title").addEventListener("input", e => {
        node.title = e.target.textContent.trim() || "Untitled";
      });

      li.querySelector(".add-btn").addEventListener("click", () => {
        const child = createNode();
        node.children.push(child);

        let childUl = li.querySelector("ul");
        if (!childUl) {
          childUl = document.createElement("ul");
          li.appendChild(childUl);
        }

        renderNodes(childUl, node.children);
        initSortableForTree(childUl);
      });

      li.querySelector(".delete-btn").addEventListener("click", () => {
        if (tree.nodes.length <= 1 && node.children.length === 0) {
          alert("Cannot delete all root nodes.");
          return;
        }
        removeNode(tree.nodes, node.id);
        li.remove();
      });
    });
  }

  function initSortableForTree(ul) {
    new Sortable(ul, {
      group: 'nested',
      animation: 150,
      fallbackOnBody: true,
      swapThreshold: 0.65,
      onEnd: () => updateTreeDataFromDOM(ul)
    });
  }

  function updateTreeDataFromDOM(ul) {
    function parseUL(ul) {
      return Array.from(ul.children).map(li => {
        const nodeId = li.dataset.nodeId;
        const node = findNode(tree.nodes, Number(nodeId));
        const childUl = li.querySelector("ul");
        if (childUl) node.children = parseUL(childUl);
        return node;
      });
    }
    tree.nodes = parseUL(ul);
  }

  window.submitHierarchy = async function() {
    const username = document.getElementById("username").value || "Anonymous";
    try {
      await addDoc(collection(db, "submissions"), {
        username,
        tree,
        timestamp: new Date()
      });
      alert("Hierarchy submitted successfully!");
    } catch (e) {
      console.error("Error submitting:", e);
      alert("Failed to submit hierarchy.");
    }
  };

  window.onload = function() {
    renderTree(tree);
  };
</script>

<style>
body { font-family: sans-serif; margin: 2rem; }
ul { list-style-type: none; padding-left: 1rem; }
li { margin: 0.1rem 0; padding: 0.25rem 0.5rem; border-radius: 4px; }

/* alternating background for readability */
li:nth-child(odd) { background: #f0f0f0; }
li:nth-child(even) { background: #fafafa; }

/* nested children vertical line */
li li { border-left: 2px solid #ccc; margin-left: 0.5rem; padding-left: 0.5rem; }

/* hover and drag highlights */
li:hover { background-color: #d0ebff; }
.sortable-chosen { background-color: #a0d2ff !important; box-shadow: 0 2px 6px rgba(0,0,0,0.2); }
.sortable-ghost { opacity: 0.5; }

button { margin-left: 0.5rem; }
.title { outline: none; }
.tree-wrapper { margin-bottom: 1rem; padding: 0.5rem; border: 1px solid #aaa; border-radius: 6px; }
</style>
</head>
<body>

<h1>Information Hierarchy Exercise</h1>
<p>Use the box below to create a structure for our Shared Drive. Add or delete items using the buttons. Drag items to organize them inside or outside the highlighted areas. Click on titles to edit them. 
<br>
<br>
Please do not submit confidential information in this form. Where relevant, consider using more general terms or placeholder names like "Partner A". 
<br>
<br>
When you are satisfied, enter your name/initials and click Submit. </p>

<input type="text" id="username" placeholder="Enter your name">
<button onclick="submitHierarchy()">Submit Hierarchy</button>

<div id="trees-container"></div>

</body>
</html>
