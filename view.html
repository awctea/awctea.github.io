<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>View Submissions</title>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-app.js";
  import { getFirestore, collection, getDocs, orderBy, query } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAsGafeMKHVxAeUVAroHj-FqyPiRaDDyqE",
  authDomain: "test-769a6.firebaseapp.com",
  projectId: "test-769a6",
  storageBucket: "test-769a6.firebasestorage.app",
  messagingSenderId: "1073801314798",
  appId: "1:1073801314798:web:abd01ae67a5bc9c1eb0eff"
};
  
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // ---------------- Render Functions ----------------
  function renderNode(node, depth = 0) {
    const li = document.createElement("li");
    li.className = `node-item depth-${depth}`;
    
    const titleSpan = document.createElement("span");
    titleSpan.className = "node-title";
    titleSpan.textContent = node.title || "Untitled";
    li.appendChild(titleSpan);

    if (node.children && node.children.length > 0) {
      const childrenCount = document.createElement("span");
      childrenCount.className = "children-count";
      childrenCount.textContent = ` (${node.children.length} items)`;
      li.appendChild(childrenCount);

      const ul = document.createElement("ul");
      ul.className = "child-list";
      node.children.forEach(child => ul.appendChild(renderNode(child, depth + 1)));
      li.appendChild(ul);
    }
    return li;
  }

  function renderTree(tree) {
    const ul = document.createElement("ul");
    ul.className = "tree-view";
    
    if (tree.nodes && tree.nodes.length > 0) {
      tree.nodes.forEach(node => ul.appendChild(renderNode(node, 0)));
    } else {
      const li = document.createElement("li");
      li.className = "empty-tree";
      li.textContent = "No items in this tree";
      ul.appendChild(li);
    }
    
    return ul;
  }

  function countTotalNodes(nodes) {
    let count = 0;
    nodes.forEach(node => {
      count++; // Count this node
      if (node.children && node.children.length > 0) {
        count += countTotalNodes(node.children); // Recursively count children
      }
    });
    return count;
  }

  function getTreeStats(tree) {
    if (!tree.nodes || tree.nodes.length === 0) {
      return { totalNodes: 0, maxDepth: 0, rootNodes: 0 };
    }

    function getMaxDepth(nodes, currentDepth = 0) {
      let maxDepth = currentDepth;
      nodes.forEach(node => {
        if (node.children && node.children.length > 0) {
          maxDepth = Math.max(maxDepth, getMaxDepth(node.children, currentDepth + 1));
        }
      });
      return maxDepth;
    }

    return {
      totalNodes: countTotalNodes(tree.nodes),
      maxDepth: getMaxDepth(tree.nodes),
      rootNodes: tree.nodes.length
    };
  }

  // ---------------- Load Submissions ----------------
  async function loadSubmissions() {
    const container = document.getElementById("submissions");
    const loadingDiv = document.createElement("div");
    loadingDiv.className = "loading";
    loadingDiv.innerHTML = `
      <div class="spinner"></div>
      <p>Loading submissions...</p>
    `;
    container.appendChild(loadingDiv);

    try {
      const submissionsRef = collection(db, "submissions");
      const q = query(submissionsRef, orderBy("timestamp", "desc"));
      const snapshot = await getDocs(q);
      
      container.innerHTML = ""; // Clear loading

      if (snapshot.empty) {
        container.innerHTML = `
          <div class="no-submissions">
            <h2>No submissions yet</h2>
            <p>Submissions will appear here once users complete the organization exercise.</p>
          </div>
        `;
        return;
      }

      const submissionCount = document.createElement("div");
      submissionCount.className = "submission-count";
      submissionCount.textContent = `Total Submissions: ${snapshot.size}`;
      container.appendChild(submissionCount);

      snapshot.forEach(doc => {
        const data = doc.data();
        const div = document.createElement("div");
        div.className = "submission";

        // Header with user info
        const header = document.createElement("div");
        header.className = "submission-header";
        
        const userInfo = document.createElement("div");
        userInfo.className = "user-info";
        const username = document.createElement("h3");
        username.textContent = data.username || "Anonymous";
        const timestamp = document.createElement("div");
        timestamp.className = "timestamp";
        timestamp.textContent = new Date(data.timestamp.seconds * 1000).toLocaleString();
        
        userInfo.appendChild(username);
        userInfo.appendChild(timestamp);
        header.appendChild(userInfo);

        // Tree stats
        let tree = data.tree || (data.trees && data.trees[0]); // Handle both old and new data structure
        if (tree) {
          const stats = getTreeStats(tree);
          const statsDiv = document.createElement("div");
          statsDiv.className = "tree-stats";
          statsDiv.innerHTML = `
            <div class="stat">
              <span class="stat-label">Total Items:</span>
              <span class="stat-value">${stats.totalNodes}</span>
            </div>
            <div class="stat">
              <span class="stat-label">Root Categories:</span>
              <span class="stat-value">${stats.rootNodes}</span>
            </div>
            <div class="stat">
              <span class="stat-label">Max Depth:</span>
              <span class="stat-value">${stats.maxDepth}</span>
            </div>
          `;
          header.appendChild(statsDiv);
        }

        div.appendChild(header);

        // Render the tree structure
        const treeContainer = document.createElement("div");
        treeContainer.className = "tree-container";
        
        if (tree) {
          treeContainer.appendChild(renderTree(tree));
        } else if (data.trees && data.trees.length > 0) {
          // Handle old multi-tree format
          data.trees.forEach((tree, index) => {
            const treeHeader = document.createElement("h4");
            treeHeader.textContent = `Tree ${index + 1}`;
            treeContainer.appendChild(treeHeader);
            treeContainer.appendChild(renderTree(tree));
          });
        } else {
          treeContainer.innerHTML = "<p class='no-data'>No tree data found</p>";
        }

        div.appendChild(treeContainer);
        container.appendChild(div);
      });

    } catch (error) {
      console.error("Error loading submissions:", error);
      container.innerHTML = `
        <div class="error">
          <h2>Error Loading Submissions</h2>
          <p>There was a problem loading the submissions. Please try refreshing the page.</p>
          <details>
            <summary>Technical Details</summary>
            <pre>${error.message}</pre>
          </details>
        </div>
      `;
    }
  }

  window.onload = loadSubmissions;
</script>

<style>
body { 
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
  margin: 2rem; 
  line-height: 1.5;
  background-color: #f8f9fa;
  color: #333;
}

h1 {
  color: #1565c0;
  font-weight: 600;
  margin-bottom: 2rem;
  text-align: center;
  font-size: 2.5rem;
}

.submission-count {
  background: linear-gradient(135deg, #2196f3, #1976d2);
  color: white;
  padding: 1rem 2rem;
  border-radius: 8px;
  text-align: center;
  font-weight: 600;
  font-size: 1.1rem;
  margin-bottom: 2rem;
  box-shadow: 0 2px 8px rgba(33, 150, 243, 0.3);
}

.submission { 
  margin-bottom: 3rem; 
  padding: 0;
  border: 2px solid #dee2e6; 
  border-radius: 12px;
  background: white;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  overflow: hidden;
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.submission:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(0,0,0,0.15);
}

.submission-header {
  background: linear-gradient(135deg, #f8f9fa, #e9ecef);
  padding: 1.5rem;
  border-bottom: 1px solid #dee2e6;
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  flex-wrap: wrap;
  gap: 1rem;
}

.user-info h3 { 
  margin: 0 0 0.5rem 0;
  color: #1565c0;
  font-size: 1.4rem;
  font-weight: 600;
}

.timestamp {
  color: #666;
  font-size: 0.9rem;
  font-weight: 500;
}

.tree-stats {
  display: flex;
  gap: 1.5rem;
  flex-wrap: wrap;
}

.stat {
  display: flex;
  flex-direction: column;
  align-items: center;
  min-width: 80px;
}

.stat-label {
  font-size: 0.8rem;
  color: #666;
  font-weight: 500;
  margin-bottom: 0.25rem;
}

.stat-value {
  font-size: 1.5rem;
  font-weight: bold;
  color: #1565c0;
}

.tree-container {
  padding: 1.5rem;
}

ul.tree-view { 
  list-style-type: none; 
  padding-left: 0;
  margin: 0;
}

ul.child-list {
  list-style-type: none; 
  padding-left: 2rem;
  margin-top: 0.5rem;
}

.node-item { 
  margin: 0.5rem 0; 
  padding: 0.75rem 1rem;
  border-radius: 6px;
  background: #f8f9fa;
  border: 1px solid #e9ecef;
  transition: all 0.2s ease;
  position: relative;
}

.node-item:hover {
  background: #e3f2fd;
  border-color: #2196f3;
}

.node-item.depth-0 {
  background: linear-gradient(135deg, #e3f2fd, #f3e5f5);
  border: 2px solid #2196f3;
  font-weight: 600;
  font-size: 1.1rem;
}

.node-item.depth-1 {
  background: #f0f7ff;
  border-left: 4px solid #2196f3;
}

.node-item.depth-2 {
  background: #f8fbff;
  border-left: 3px solid #64b5f6;
}

.node-title {
  color: #333;
  font-weight: 500;
}

.depth-0 .node-title {
  color: #1565c0;
  font-weight: 700;
}

.children-count {
  color: #666;
  font-size: 0.9rem;
  font-weight: normal;
  font-style: italic;
}

.empty-tree {
  color: #999;
  font-style: italic;
  text-align: center;
  padding: 2rem;
  background: #f8f9fa;
  border: 2px dashed #ddd;
  border-radius: 8px;
}

.loading {
  text-align: center;
  padding: 3rem;
}

.spinner {
  border: 4px solid #f3f3f3;
  border-top: 4px solid #2196f3;
  border-radius: 50%;
  width: 40px;
  height: 40px;
  animation: spin 2s linear infinite;
  margin: 0 auto 1rem auto;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.no-submissions {
  text-align: center;
  padding: 4rem 2rem;
  background: white;
  border: 2px dashed #ddd;
  border-radius: 12px;
  color: #666;
}

.no-submissions h2 {
  color: #999;
  margin-bottom: 1rem;
}

.error {
  background: #ffebee;
  border: 2px solid #f44336;
  border-radius: 12px;
  padding: 2rem;
  text-align: center;
}

.error h2 {
  color: #d32f2f;
  margin-bottom: 1rem;
}

.error details {
  text-align: left;
  margin-top: 1rem;
  background: #fff;
  padding: 1rem;
  border-radius: 6px;
  border: 1px solid #ddd;
}

.no-data {
  color: #999;
  font-style: italic;
  text-align: center;
  padding: 1rem;
}

@media (max-width: 768px) {
  body {
    margin: 1rem;
  }
  
  .submission-header {
    flex-direction: column;
    align-items: stretch;
  }
  
  .tree-stats {
    justify-content: center;
  }
  
  ul.child-list {
    padding-left: 1rem;
  }
  
  h1 {
    font-size: 2rem;
  }
}
</style>
</head>
<body>
<h1>All Submitted Hierarchies</h1>
<div id="submissions"></div>
</body>
</html>
