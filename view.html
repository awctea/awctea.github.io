<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>View Submissions</title>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-app.js";
import { getFirestore, collection, getDocs, orderBy, query } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAsGafeMKHVxAeUVAroHj-FqyPiRaDDyqE",
  authDomain: "test-769a6.firebaseapp.com",
  projectId: "test-769a6",
  storageBucket: "test-769a6.firebasestorage.app",
  messagingSenderId: "1073801314798",
  appId: "1:1073801314798:web:abd01ae67a5bc9c1eb0eff"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

function renderNode(node, depth = 0) {
  const li = document.createElement('li');
  li.className = `node-item depth-${depth}`;
  const span = document.createElement('span');
  span.textContent = node.title || 'Untitled';
  li.appendChild(span);

  if (node.children && node.children.length) {
    const ul = document.createElement('ul');
    node.children.forEach(child => ul.appendChild(renderNode(child, depth + 1)));
    li.appendChild(ul);
  }
  return li;
}

function renderTree(tree) {
  const ul = document.createElement('ul');
  ul.className = 'tree-view';
  if (tree && tree.nodes && Array.isArray(tree.nodes)) {
    tree.nodes.forEach(node => ul.appendChild(renderNode(node, 0)));
  } else {
    const li = document.createElement('li');
    li.textContent = 'No items in this tree';
    ul.appendChild(li);
  }
  return ul;
}

function countNodes(nodes) {
  let count = 0;
  nodes.forEach(n => {
    count++;
    if (n.children) count += countNodes(n.children);
  });
  return count;
}

function getTreeStats(tree) {
  if (!tree.nodes) return { totalNodes: 0, maxDepth: 0, rootNodes: 0 };
  function maxDepth(nodes, depth = 0) {
    return nodes.reduce((max, n) => {
      if (n.children && n.children.length) {
        return Math.max(max, maxDepth(n.children, depth + 1));
      } else return Math.max(max, depth);
    }, depth);
  }
  return { totalNodes: countNodes(tree.nodes), maxDepth: maxDepth(tree.nodes), rootNodes: tree.nodes.length };
}

async function loadSubmissions() {
  const container = document.getElementById('submissions');
  container.innerHTML = '<p>Loading submissions...</p>';
  try {
    const q = query(collection(db, 'submissions'), orderBy('timestamp', 'desc'));
    const snapshot = await getDocs(q);
    container.innerHTML = '';

    if (snapshot.empty) {
      container.innerHTML = '<p>No submissions yet.</p>';
      return;
    }

    snapshot.forEach(doc => {
      const data = doc.data();
      const div = document.createElement('div');
      div.className = 'submission';

      const h3 = document.createElement('h3');
      h3.textContent = data.username || 'Anonymous';
      div.appendChild(h3);

      const ts = document.createElement('div');
      ts.className = 'timestamp';
      ts.textContent = new Date(data.timestamp.seconds * 1000).toLocaleString();
      div.appendChild(ts);

      const treeData = data.tree || (data.trees && data.trees[0]);
      if (treeData) {
        const stats = getTreeStats(treeData);
        const statsDiv = document.createElement('div');
        statsDiv.className = 'tree-stats';
        statsDiv.textContent = `Items: ${stats.totalNodes}, Roots: ${stats.rootNodes}, Max Depth: ${stats.maxDepth}`;
        div.appendChild(statsDiv);

        div.appendChild(renderTree(treeData));
      }

      container.appendChild(div);
    });
  } catch (e) {
    console.error(e);
    container.innerHTML = `<p>Error loading submissions: ${e.message}</p>`;
  }
}

window.onload = loadSubmissions;
</script>
<style>
body { font-family:sans-serif; margin:2rem; background:#f9f9f9; }
h1{text-align:center;color:#1565c0;}
.submission{background:white;border:1px solid #ccc;padding:1rem;margin-bottom:1rem;border-radius:8px;}
.tree-view, .tree-view ul{list-style:none;padding-left:1rem;}
.node-item{margin:0.3rem 0;padding:0.3rem 0.6rem;border-radius:4px;background:#f0f0f0;}
.node-item.depth-0{background:#d0e7ff;font-weight:600;}
.timestamp{font-size:0.8rem;color:#666;}
.tree-stats{font-size:0.85rem;color:#333;margin:0.5rem 0;}
</style>
</head>
<body>
<h1>All Submitted Hierarchies</h1>
<div id="submissions"></div>
</body>
</html>
